description: >
  Upload the python package to pypi if git tag is in format ^v[0-9]+(\\.[0-9]+)*$.
  Note that you have to provide PYPI_USER, PYPI_PASSWORD.

steps:
   - run:
        name: Upload packages to PYPI if git tag is in format ^v[0-9]+(\\.[0-9]+)*$
        command: |
          if [[ "$CIRCLE_TAG" =~ ^v[0-9]+(\.[0-9]+)*$ ]]; then
              if [ "$PYPI_USER" == "" ]; then
                 echo "PYPI_USER not specified" && exit 1
              fi
              pip install twine
              # Init .pypirc
              echo -e "[pypi]" >> ~/.pypirc
              echo -e "username = $PYPI_USER" >> ~/.pypirc
              echo -e "password = $PYPI_PASSWORD" >> ~/.pypirc
              # Make packages
              python setup.py sdist
              python setup.py bdist_wheel
              # Upload to pypi
              twine upload dist/*
          else
              echo "Skipping the PYPI upload because git tag ($CIRCLE_TAG) is not in format ^v[0-9]+(\\.[0-9]+)*$";
          fi;
